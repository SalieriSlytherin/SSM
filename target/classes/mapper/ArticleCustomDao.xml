<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nuc.calvin.ssm.dao.ArticleCustomDao">
    <resultMap id="ArticleResultMap" type="com.nuc.calvin.ssm.entity.ArticleCustom">
        <id column="articleId" property="articleId" jdbcType="INTEGER"/>
        <id column="userId" property="userId" jdbcType="INTEGER"/>
        <id column="articleTitle" property="articleTitle" jdbcType="VARCHAR"/>
        <id column="articleUrl" property="articleUrl" jdbcType="VARCHAR"/>
        <id column="postTime" property="postTime" jdbcType="TIMESTAMP"/>

        <!-- 一对一关系-->
        <association property="user" javaType="com.nuc.calvin.ssm.entity.User">
            <id column="userId" property="userId" jdbcType="INTEGER"/>
            <result column="username" property="username" jdbcType="VARCHAR"/>
            <result column="password" property="password" jdbcType="VARCHAR"/>
            <result column="email" property="email" jdbcType="VARCHAR"/>
            <result column="signature" property="signature" jdbcType="VARCHAR"/>
            <result column="sex" property="sex" jdbcType="INTEGER"/>
            <result column="headImg" property="headImg" jdbcType="VARCHAR"/>
            <result column="singUpTime" property="singUpTime" jdbcType="DATE"/>
        </association>
    </resultMap>

    <!-- 根据文章id查询微博 -->
    <select id="queryArticleByArticleId" parameterType="int" resultMap="ArticleResultMap">
        select * from article,user where article.articleId=#{articleId,jdbcType=INTEGER}
        and user.userId=article.userId
    </select>

    <!-- 根据微博id删除微博 -->
    <delete id="deleteByArticleId" parameterType="int">
        delete from article where articleId=#{articleId,jdbcType=INTEGER}
    </delete>

    <!-- 根据用户id查询微博 附加user昵称 头像 -->
    <select id="queryArticleByUserId" parameterType="Integer" resultMap="ArticleResultMap">
        select
        user.username,user.headImg,article.* from article,user
        <where>
            and article.userId=#{userId,jdbcType=INTEGER}
            and article.userId=user.userIdorder by post_time desc
        </where>
    </select>

    <!-- 发文章 -->
    <insert id="postArticle" parameterType="com.nuc.calvin.ssm.entity.ArticleVo" keyProperty="articleId"
            useGeneratedKeys="true">
        insert into article
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="articleCustom.userId != null">
                userId
            </if>
            <if test="articleCustom.articleTitle != null">
                articleTitle
            </if>
            <if test="articleCustom.articleUrl != null">
                articleUrl
            </if>
            <if test="articleCustom.postTime != null">
                postTime
            </if>
        </trim>
        <trim prefix="values(" suffix=")" suffixOverrides=",">
            <if test="articleCustom.userId != null">
                #{articleCustom.userId,jdbcType=INTEGER}
            </if>
            <if test="articleCustom.articleTitle != null">
                #{articleCustom.articleTitle,jdbcType=VARCHAR}
            </if>
            <if test="articleCustom.articleUrl != null">
                #{articleCustom.articleUrl,jdbcType=VARCHAR}
            </if>
            <if test="articleCustom.postTime != null">
                #{articleCustom.postTime,jdbcType=TIMESTAMP}
            </if>
        </trim>
    </insert>

    <!--查询微博被评论次数-->
    <select id="queryCommentCount" parameterType="int" resultType="int">
        select count(*)
        from comment
        where comment.articleId=#{articleId,jdbcType=INTEGER}
    </select>

    <!--查询微博被回复次数-->
    <select id="queryReplyCount" parameterType="int" resultType="int">
        select count(*)
        from reply as r
        where r.commentId in(
        select commentId
        from comment
        where comment.articleId=#{articleId,jdbcType=INTEGER}
        )
    </select>

    <!--查询文章被点赞次数-->
    <select id="queryLikeCount" parameterType="int" resultType="int">
        select count(*)
        form likes
        where articleId=#{articleId,jdbcType=INTEGER}
    </select>

    <!-- 根据关键字搜索微博 -->
    <select id="queryArticleByWord" parameterType="String" resultMap="ArticleResultMap">
	select user.username,user.headImg,article.*
	from article,user
	where article.articleTitle like '%${keyWord,jdbcType=VARCHAR}%'
	and article.userId=user.userId order by postTime desc
	</select>

    <select id="queryAllArticle" resultMap="ArticleResultMap">
        select * from article
    </select>
</mapper>